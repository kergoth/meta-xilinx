From cd8d545c980038a442e961ce206ec67eb8a8a78f Mon Sep 17 00:00:00 2001
From: Yasir-Khan <yasir_khan@mentor.com>
Date: Fri, 30 Dec 2016 20:55:30 +0500
Subject: [PATCH] serial: xuartps: Enable loopback mode

Enable loopback mode in Xilinx uart driver.

JiraID: SB-8470

Signed-off-by: Yasir-Khan <yasir_khan@mentor.com>
---
 drivers/tty/serial/xilinx_uartps.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/drivers/tty/serial/xilinx_uartps.c b/drivers/tty/serial/xilinx_uartps.c
index a27bd37b..a8687ee 100644
--- a/drivers/tty/serial/xilinx_uartps.c
+++ b/drivers/tty/serial/xilinx_uartps.c
@@ -98,6 +98,7 @@ MODULE_PARM_DESC(rx_timeout, "Rx timeout, 1-255");
 #define CDNS_UART_MR_CLKSEL		0x00000001  /* Pre-scalar selection */
 #define CDNS_UART_MR_CHMODE_L_LOOP	0x00000200  /* Local loop back mode */
 #define CDNS_UART_MR_CHMODE_NORM	0x00000000  /* Normal mode */
+#define CDNS_UART_MR_CHMODE_MASK	0x00000300  /* Mask for mode bits */
 
 #define CDNS_UART_MR_STOPMODE_2_BIT	0x00000080  /* 2 stop bits */
 #define CDNS_UART_MR_STOPMODE_1_BIT	0x00000000  /* 1 stop bit */
@@ -1000,15 +1001,25 @@ static unsigned int cdns_uart_get_mctrl(struct uart_port *port)
 static void cdns_uart_set_mctrl(struct uart_port *port, unsigned int mctrl)
 {
 	u32 val;
+	u32 mode_reg;
 
 	val = cdns_uart_readl(CDNS_UART_MODEMCR_OFFSET);
+	mode_reg = cdns_uart_readl(CDNS_UART_MR_OFFSET);
 
 	val &= ~(CDNS_UART_MODEMCR_RTS | CDNS_UART_MODEMCR_DTR);
+	mode_reg &= ~CDNS_UART_MR_CHMODE_MASK;
 
 	if (mctrl & TIOCM_RTS)
 		val |= CDNS_UART_MODEMCR_RTS;
 	if (mctrl & TIOCM_DTR)
 		val |= CDNS_UART_MODEMCR_DTR;
+	if (mctrl & TIOCM_LOOP) {
+		mode_reg |= CDNS_UART_MR_CHMODE_L_LOOP;
+		cdns_uart_writel(mode_reg, CDNS_UART_MR_OFFSET);
+	} else {
+		mode_reg |= CDNS_UART_MR_CHMODE_NORM;
+		cdns_uart_writel(mode_reg, CDNS_UART_MR_OFFSET);
+	}
 
 	cdns_uart_writel(val, CDNS_UART_MODEMCR_OFFSET);
 }
-- 
2.8.1

